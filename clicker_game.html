<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Click Random</title>
  <style>
    :root{
      --bg:#071026; --card:#0b1220; --accent:#20c997; --accent-2:#ffb86b; --muted:#94a3b8;
      --glass: rgba(255,255,255,0.03); --glass-2: rgba(255,255,255,0.02);
      --danger:#fb7185; --success:#4ade80;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#03071a 0%, #071427 100%);color:#e6eef8}
    .wrap{max-width:1400px;margin:18px auto;padding:18px;display:grid;grid-template-columns:1fr 480px;gap:18px}
    .panel{background:linear-gradient(180deg,var(--card), #07101a);border-radius:12px;padding:14px;box-shadow:0 12px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .game-area{display:flex;flex-direction:column;align-items:center;gap:12px;min-height:720px}
    .big-btn{width:360px;height:360px;border-radius:999px;background:radial-gradient(circle at 30% 20%, #ffd9b2 0%, #ffb86b 40%, #ff8f3c 100%);display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;box-shadow:0 22px 80px rgba(255,150,50,0.12), inset 0 -10px 26px rgba(0,0,0,0.14);transition:transform .08s ease, box-shadow .08s ease, filter 160ms ease;position:relative}
    .big-btn:active{transform:scale(.96)}
    .big-btn .label{font-size:30px;color:#1b1b1b;font-weight:800;text-shadow:0 2px 0 rgba(255,255,255,0.14)}
    .big-btn img.skin-img{width:100%;height:100%;object-fit:cover;border-radius:999px;display:block;pointer-events:none}
    .hud{display:flex;gap:10px;align-items:center}
    .stat{background:var(--glass);padding:10px 12px;border-radius:10px;color:var(--muted);font-weight:700;min-width:120px;text-align:center}
    .stat strong{display:block;color:var(--accent-2);font-size:18px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .ghost-btn{background:transparent;border:1px dashed rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:var(--muted);cursor:pointer}
    .primary{background:linear-gradient(180deg,var(--accent),#1e9b7f);border-radius:8px;padding:8px 12px;border:none;color:#04161a;cursor:pointer}
    .danger{background:linear-gradient(180deg,var(--danger),#ff7a8a);border-radius:8px;padding:8px 12px;border:none;color:#fff;cursor:pointer}
    .success{background:linear-gradient(180deg,var(--success),#16a34a);border-radius:8px;padding:8px 12px;border:none;color:#03140f;cursor:pointer}
    .log{background:linear-gradient(180deg,#06101a,transparent);padding:12px;border-radius:10px;min-height:140px;max-height:260px;overflow:auto;font-size:13px;color:var(--muted)}
    .sidebar{display:flex;flex-direction:column;gap:12px}
    .section-title{font-size:13px;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
    .upgrades{display:grid;grid-template-columns:1fr;gap:8px;max-height:360px;overflow:auto;padding-right:6px}
    .upgrade{display:flex;align-items:center;gap:12px;padding:8px;border-radius:8px;background:linear-gradient(180deg,var(--glass-2),transparent);border:1px solid rgba(255,255,255,0.02)}
    .upgrade .info{flex:1}
    .upgrade .name{font-weight:800}
    .ach-grid{display:flex;gap:8px;flex-wrap:wrap;max-height:260px;overflow:auto;padding-right:6px}
    .ach{padding:8px 10px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);font-size:13px}
    .skin-row{display:flex;gap:10px;align-items:center}
    .skin-thumb{width:56px;height:56px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
    .skin-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .skin-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:420px;overflow:auto;padding-right:6px}
    .skin-card{height:96px;border-radius:8px;background:linear-gradient(180deg,#071827,transparent);display:flex;align-items:center;gap:8px;padding:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.03)}
    .skin-meta{font-size:12px;color:var(--muted)}
    .player-list{display:flex;flex-direction:column;gap:6px;max-height:200px;overflow:auto;padding-right:6px}
    .player-row{display:flex;justify-content:space-between;gap:8px;padding:6px;border-radius:6px;background:rgba(255,255,255,0.02)}
    .stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999}
    .modal{background:var(--card);padding:16px;border-radius:10px;width:820px;max-width:96%;box-shadow:0 30px 80px rgba(2,6,23,0.7)}
    .small{font-size:12px;color:var(--muted)}
    .admin-modal-backdrop{position:fixed;left:0;top:0;right:0;bottom:0;background:linear-gradient(180deg, rgba(0,0,0,0.85), rgba(0,0,0,0.9));display:flex;align-items:center;justify-content:center;z-index:10001}
    .admin-modal{background:linear-gradient(180deg,#0d1722,#07101a);color:#e6eef8;padding:20px;border-radius:12px;width:840px;max-width:96%;box-shadow:0 30px 120px rgba(0,0,0,0.8);border:1px solid rgba(255,255,255,0.03)}
    .theme-preview{width:72px;height:72px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
    .update-log{max-height:420px;overflow:auto;padding-right:8px;background:linear-gradient(180deg,#071427,transparent);border-radius:8px;padding:12px;color:var(--muted);border:1px solid rgba(255,255,255,0.02)}
    @media(max-width:1100px){.wrap{grid-template-columns:1fr;padding:12px}.big-btn{width:300px;height:300px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel game-area">
      <div style="width:100%;display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small">Player:</label>
          <input id="playerName" value="" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)" placeholder="Your name">
          <button class="ghost-btn" id="joinBtn">Join</button>
          <button class="ghost-btn" id="simulateBtn">Simulate players</button>
        </div>
        <div class="controls">
          <button class="ghost-btn" id="patchNotesBtn">Patch Notes</button>
          <button class="ghost-btn" id="saveBtn">Save</button>
          <button class="ghost-btn" id="exportBtn">Export</button>
          <button class="ghost-btn" id="importBtn">Import</button>
          <button class="ghost-btn" id="resetBtn">Reset</button>
          <button class="ghost-btn" id="skinsBtn">Skins</button>
        </div>
      </div>

      <div class="hud" style="margin-top:10px">
        <div class="stat">Cookies <strong id="cookies">0</strong></div>
        <div class="stat">CPS <strong id="cps">0</strong></div>
        <div class="stat">Clicks <strong id="clicks">0</strong></div>
        <div class="stat">Prestige <strong id="prestige">0</strong></div>
      </div>

      <div id="bigBtn" class="big-btn" tabindex="0" role="button" aria-pressed="false" title="Click (or Space)">
        <div class="label" id="bigLabel">Bake!</div>
      </div>

      <div class="prestige-area" id="prestigeArea" aria-live="polite" style="width:100%;max-width:420px;margin-top:12px">
        <button id="prestigeBtn" class="prestige-btn" style="display:inline-block;background:linear-gradient(180deg,#ffd86b,#ffb86b);color:#1a1a1a;border-radius:10px;padding:10px 12px;border:none;cursor:pointer;font-weight:800;box-shadow:0 10px 30px rgba(255,150,0,0.12)">Prestige â€” Cost: <span id="prestigeCost">0</span></button>
      </div>

      <div style="width:100%;max-width:980px;text-align:center;color:var(--muted);margin-top:8px">
        <div class="log" id="log" aria-live="polite">Welcome to Random Click! Press Patch Notes to view updates or Play to jump in.</div>
      </div>
    </div>

    <aside class="panel sidebar">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="section-title">Store & Upgrades</div>
          <div><small class="small">Auto price scaling on producers</small></div>
        </div>
        <div class="upgrades" id="upgrades"></div>
        <div style="margin-top:8px"><div class="section-title">Producers</div><div class="upgrades" id="store"></div></div>
      </div>

      <div style="margin-top:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="section-title">Skins & Themes</div>
          <div><button class="ghost-btn" id="openSkinsShopBtn">Open Shop</button></div>
        </div>
        <div class="skin-grid" id="skinGrid"></div>
      </div>

      <div style="margin-top:6px">
        <div class="section-title">Players (local tabs)</div>
        <div class="player-list" id="playerList"></div>
      </div>

      <div style="margin-top:8px">
        <div class="section-title">Achievements</div>
        <div class="ach-grid" id="achievements"></div>
      </div>

      <div style="margin-top:10px" class="small">Version 4.0 â€” Random Click (Patched)</div>
    </aside>
  </div>

  <!-- Templates -->
  <template id="upgradeTemplate">
    <div class="upgrade">
      <div class="info">
        <div class="name">NAME</div>
        <div class="small desc">DESCRIPTION</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:14px;color:var(--muted)"><strong class="cost">0</strong></div>
        <div style="margin-top:8px"><button class="buyBtn primary">Buy</button></div>
      </div>
    </div>
  </template>

  <template id="skinsModalTpl">
    <div class="modal-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <h3>Skins & Themes Shop</h3>
        <p class="small">Upload skins (upload cost tiers apply) or buy from the shop. Themes are available under the Themes tab.</p>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="flex:1">
            <div style="margin-bottom:8px"><strong>Your balance:</strong> <span id="shopBalance">0</span> cookies</div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
              <input type="file" id="uploadSkinInput" accept="image/*">
              <button class="ghost-btn" id="uploadSkinBtn">Upload Skin (cost)</button>
            </div>
            <div id="ownedSkinsPanel" style="max-height:320px;overflow:auto;padding-right:6px"></div>
          </div>

          <div style="width:420px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div><strong>Shop â€” Tabs: <button class="ghost-btn" id="tabSkins">Skins</button> <button class="ghost-btn" id="tabThemes">Themes</button></strong></div>
              <div><input id="skinSearch" placeholder="search skins/themes" style="padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)"></div>
            </div>
            <div id="shopSkins" style="max-height:420px;overflow:auto;padding-right:6px"></div>
            <div id="shopThemes" style="max-height:420px;overflow:auto;padding-right:6px;display:none"></div>
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="ghost-btn" id="closeSkinsModal">Close</button>
        </div>
      </div>
    </div>
  </template>

  <template id="adminModalTpl">
    <div class="admin-modal-backdrop">
      <div class="admin-modal" role="dialog" aria-modal="true">
        <h2>Admin Panel â€” Random Click (GODMODE)</h2>
        <p class="small">Every open requires the admin password (<em>BakAdmin1</em>).</p>

        <div style="display:flex;flex-direction:column;gap:12px;margin-top:8px">
          <div style="display:flex;gap:12px;align-items:center">
            <label class="small" style="min-width:180px">Allow Hold-Space Auto-Click</label>
            <input type="checkbox" id="adminHoldToggle">
            <div class="small">When enabled, holding Space will repeatedly click (use responsibly).</div>
          </div>

          <div style="display:flex;gap:12px;align-items:center">
            <label class="small" style="min-width:180px">Grant Cookies</label>
            <input id="adminGrantCookies" placeholder="amount" style="padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)">
            <button class="ghost-btn" id="adminGrantCookiesBtn">Grant</button>
          </div>

          <div style="display:flex;gap:12px;align-items:center">
            <label class="small" style="min-width:180px">Give Upgrade (id)</label>
            <input id="adminGiveUpgrade" placeholder="upgrade id" style="padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)">
            <button class="ghost-btn" id="adminGiveUpgradeBtn">Grant Upgrade</button>
          </div>

          <div style="display:flex;gap:12px;align-items:center">
            <label class="small" style="min-width:180px">Spawn Skin</label>
            <input id="adminSpawnSkinName" placeholder="skin name" style="padding:6px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)">
            <button class="ghost-btn" id="adminSpawnSkinBtn">Spawn & Own</button>
          </div>

          <div style="display:flex;gap:12px;align-items:center">
            <label class="small" style="min-width:180px">Force Prestige</label>
            <button class="ghost-btn" id="adminForcePrestigeBtn">Force Prestige +1</button>
          </div>

          <div style="display:flex;gap:12px;align-items:center">
            <label class="small" style="min-width:180px">Dev Mode</label>
            <input type="checkbox" id="adminDevMode">
            <div class="small">When enabled, extra debug logs and fast ticks will be available.</div>
          </div>

          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
            <button class="ghost-btn" id="adminCloseBtn">Close Admin Panel</button>
          </div>
        </div>
      </div>
    </div>
  </template>

<script>
/* RANDOM CLICK â€” Patched full file (start)
   This patched version includes:
   - Prestige system (resets upgrades, doubles click power per prestige)
   - Skins + Themes shop (upload costs, buyable themes)
   - Admin panel (password protected)
   - 40+ upgrades & many achievements
   - Multiplayer presence via BroadcastChannel
   - Autosave, export/import, reset
   - Patch notes modal
*/

/* -------------------------
   Utilities & formatting
   ------------------------- */
const fmt = n => {
  if (n === null || n === undefined) return '0';
  n = Number(n) || 0;
  if (n < 1000) return Math.floor(n).toString();
  const power = Math.floor(Math.log10(Math.abs(n)) / 3);
  const suffix = ['K','M','B','T','Qa','Qi','Sx','Sp','Oc','No','Dc'][power-1] || ('e'+(power*3));
  const val = n / Math.pow(1000, power);
  return val.toFixed(val<10?2:1) + suffix;
};

/* -------------------------
   Default game state
   ------------------------- */
const DEFAULT = {
  cookies: 0,
  clicks: 0,
  cps: 0,
  multiplier: 1,
  upgrades: {},
  producers: {},
  producerCosts: {},
  achievements: {},
  skins: {},
  ownedSkins: [],
  selectedSkin: null,
  playerName: null,
  presence: {},
  prestige: 0,
  prestigeCost: 20000000000, // 20B
  lastSaved: null,
  uploadTier: 0,
  adminHoldEnabled: false,
  devMode: false
};
const SAVE_KEY = 'random_click_v4_full_patch';

/* -------------------------
   Items / Upgrades / Producers
   ------------------------- */
/* Large list; more items appended later in file */
const ITEMS = {
  // Click upgrades (one-time)
  clickPower1: { id:'clickPower1', name:'Stronger Hands', desc:'+1 cookies per click', cost:50, effect:(g)=>{ g.multiplier += 1; }, type:'one-time' },
  clickPower2: { id:'clickPower2', name:'Gloved Hands', desc:'+5 cookies per click', cost:500, effect:(g)=>{ g.multiplier += 5; }, type:'one-time' },
  goldenGloves: { id:'goldenGloves', name:'Golden Gloves', desc:'+15 click power', cost:2000, effect:(g)=>{ g.multiplier += 15; }, type:'one-time' },
  titaniumFingers: { id:'titaniumFingers', name:'Titanium Fingers', desc:'+30 click power', cost:8000, effect:(g)=>{ g.multiplier += 30; }, type:'one-time' },
  cookieHammer: { id:'cookieHammer', name:'Cookie Hammer', desc:'Double click multiplier', cost:12000, effect:(g)=>{ g.multiplier *= 2; }, type:'one-time' },
  quantumWhisk: { id:'quantumWhisk', name:'Quantum Whisk', desc:'+150 click power', cost:25000, effect:(g)=>{ g.multiplier += 150; }, type:'one-time' },

  // Extra click upgrades
  butterSpread: { id:'butterSpread', name:'Butter Spread', desc:'+10 click power', cost:6000, effect:(g)=>{ g.multiplier += 10; }, type:'one-time' },
  stickyFingers: { id:'stickyFingers', name:'Sticky Fingers', desc:'+25 click power', cost:14000, effect:(g)=>{ g.multiplier += 25; }, type:'one-time' },
  megaGrip: { id:'megaGrip', name:'Mega Grip', desc:'+60 click power', cost:38000, effect:(g)=>{ g.multiplier += 60; }, type:'one-time' },
  clickAura: { id:'clickAura', name:'Click Aura', desc:'+200 click power', cost:120000, effect:(g)=>{ g.multiplier += 200; }, type:'one-time' },
  ultimateThumb: { id:'ultimateThumb', name:'Ultimate Thumb', desc:'+1000 click power', cost:750000, effect:(g)=>{ g.multiplier += 1000; }, type:'one-time' },

  // CPS modifiers (one-time)
  steamOven: { id:'steamOven', name:'Steam Oven', desc:'+50% CPS', cost:7000, effect:(g)=>{ g._flags = g._flags||{}; g._flags.steamOven = true; }, type:'one-time' },
  solarPanels: { id:'solarPanels', name:'Solar Bakery Panels', desc:'+3Ã— CPS', cost:40000, effect:(g)=>{ g._flags = g._flags||{}; g._flags.solarPanels = true; }, type:'one-time' },
  galacticCookware: { id:'galacticCookware', name:'Galactic Cookware', desc:'+10Ã— CPS', cost:120000, effect:(g)=>{ g._flags = g._flags||{}; g._flags.galacticCookware = true; }, type:'one-time' },

  // More one-time upgrades
  luckCharm: { id:'luckCharm', name:'Luck Charm', desc:'Critical clicks: chance to double cookies', cost:9000, effect:(g)=>{ g._flags = g._flags||{}; g._flags.luckCharm = true; }, type:'one-time' },
  goldenOven: { id:'goldenOven', name:'Golden Oven', desc:'+250 CPS', cost:45000, effect:(g)=>{ g._flags = g._flags||{}; g._flags.goldenOven = true; }, type:'one-time' },
  timeWarp: { id:'timeWarp', name:'Time Warp', desc:'Short burst Ã—10 CPS for 30s (manual)', cost:150000, effect:(g)=>{ g._flags = g._flags||{}; g._flags.timeWarp = true; }, type:'one-time' },
  relicStone: { id:'relicStone', name:'Relic Stone', desc:'+500 click power', cost:200000, effect:(g)=>{ g.multiplier += 500; }, type:'one-time' },
  cosmicMixer: { id:'cosmicMixer', name:'Cosmic Mixer', desc:'+2000 click power', cost:1200000, effect:(g)=>{ g.multiplier += 2000; }, type:'one-time' },
  ephemeralDust: { id:'ephemeralDust', name:'Ephemeral Dust', desc:'+5% CPS permanently', cost:3000000, effect:(g)=>{ g._flags = g._flags||{}; g._flags.ephemeralDust = (g._flags.ephemeralDust||0)+1; }, type:'one-time' },
  prestigeAccelerator: { id:'prestigeAccelerator', name:'Prestige Accelerator', desc:'Reduces next prestige cost by 10%', cost:500000000, effect:(g)=>{ g._flags = g._flags||{}; g._flags.prestigeAccelerator = true; }, type:'one-time' },

  // Producers (repeatable)
  micro: { id:'micro', name:'Micro Oven', desc:'0.25 CPS', cost:5, baseCps:0.25, type:'producer' },
  baker: { id:'baker', name:'Baker', desc:'1 CPS', cost:15, baseCps:1, type:'producer' },
  plant: { id:'plant', name:'Cookie Plant', desc:'5 CPS', cost:75, baseCps:5, type:'producer' },
  oven: { id:'oven', name:'Oven', desc:'10 CPS', cost:150, baseCps:10, type:'producer' },
  expressLane: { id:'expressLane', name:'Express Lane', desc:'12 CPS', cost:420, baseCps:12, type:'producer' },
  factory: { id:'factory', name:'Factory', desc:'100 CPS', cost:1200, baseCps:100, type:'producer' },
  robot: { id:'robot', name:'BakeBot', desc:'600 CPS', cost:8000, baseCps:600, type:'producer' },
  atomic: { id:'atomic', name:'Atomic Baker', desc:'5000 CPS', cost:12000, baseCps:5000, type:'producer' },
  drone: { id:'drone', name:'Drone Baker', desc:'2000 CPS', cost:2000, baseCps:2000, type:'producer' },
  galaxy: { id:'galaxy', name:'Galaxy Factory', desc:'20,000 CPS', cost:20000, baseCps:20000, type:'producer' },
  portal: { id:'portal', name:'Portal Oven', desc:'100,000 CPS', cost:100000, baseCps:100000, type:'producer' },
  quantumFactory: { id:'quantumFactory', name:'Quantum Factory', desc:'1M CPS (insane)', cost:999999, baseCps:1000000, type:'producer' },

  // Themes as purchasable items (type: theme)
  theme_neon: { id:'theme_neon', name:'Neon Theme', desc:'Bright neon theme', cost:1500, type:'theme' },
  theme_retro: { id:'theme_retro', name:'Retro Theme', desc:'Retro pixel vibe', cost:2500, type:'theme' },
  theme_galaxy: { id:'theme_galaxy', name:'Galaxy Theme', desc:'Starfield and nebulae', cost:12000, type:'theme' },
  theme_candy: { id:'theme_candy', name:'Candy Theme', desc:'Sweet pastel candy look', cost:8000, type:'theme' },
  theme_dark: { id:'theme_dark', name:'Midnight', desc:'Dark moody theme', cost:0, type:'theme' },

  // Some auto-clicker / utility upgrades
  autoClickerMk1: { id:'autoClickerMk1', name:'AutoClicker Mk1', desc:'Auto-clicks for you (simulated)', cost:120, effect:(g)=>{ g._flags = g._flags||{}; g._flags.autoClickerMk1 = (g._flags.autoClickerMk1||0)+1; }, type:'one-time' },
  autoClickerMk2: { id:'autoClickerMk2', name:'AutoClicker Mk2', desc:'Faster auto-clicks', cost:2500, effect:(g)=>{ g._flags = g._flags||{}; g._flags.autoClickerMk2 = (g._flags.autoClickerMk2||0)+1; }, type:'one-time' },

  // Minor boosters
  minorBoost1: { id:'minorBoost1', name:'Minor Boost I', desc:'+2 click power', cost:120, effect:(g)=>{ g.multiplier += 2; }, type:'one-time' },
  minorBoost2: { id:'minorBoost2', name:'Minor Boost II', desc:'+8 click power', cost:450, effect:(g)=>{ g.multiplier += 8; }, type:'one-time' },
  minorBoost3: { id:'minorBoost3', name:'Minor Boost III', desc:'+20 click power', cost:2200, effect:(g)=>{ g.multiplier += 20; }, type:'one-time' },

  // ... further items will be appended in additional parts
};

/* -------------------------
   Achievements
*/
const ACH = [
  {id:'firstClick', name:'First Click', desc:'Make your first click', cond:g=>g.clicks>=1},
  {id:'10Clicks', name:'10 Clicks', desc:'Click 10 times', cond:g=>g.clicks>=10},
  {id:'100Clicks', name:'100 Clicks', desc:'Click 100 times', cond:g=>g.clicks>=100},
  {id:'1kCookies', name:'1k Cookies', desc:'Have 1,000 cookies', cond:g=>g.cookies>=1000},
  {id:'10kCookies', name:'10k Cookies', desc:'Have 10,000 cookies', cond:g=>g.cookies>=10000},
  {id:'100kCookies', name:'100k Cookies', desc:'Have 100,000 cookies', cond:g=>g.cookies>=100000},
  {id:'firstProducer', name:'First Producer', desc:'Buy your first producer', cond:g=>Object.values(g.producers).some(x=>x>0)},
  {id:'collector10', name:'Collector x10', desc:'Own 10 producers total', cond:g=>Object.values(g.producers).reduce((s,n)=>s+(n||0),0)>=10},
  {id:'skinOwner', name:'Skin Owner', desc:'Own 1 skin', cond:g=>g.ownedSkins.length>=1},
  {id:'skinCollector', name:'Skin Collector', desc:'Own 10 skins', cond:g=>g.ownedSkins.length>=10},
  {id:'prestige1', name:'Prestige Once', desc:'Gain your first prestige', cond:g=>g.prestige>=1}
  // more achievements are added in subsequent chunks
];

/* -------------------------
   Skins & Themes helpers
*/
function genSkinSVG(name, size=512){
  const hash = [...name].reduce((s,c)=>s + c.charCodeAt(0), 0);
  const color1 = '#' + ((hash * 9301 + 49297) % 16777215).toString(16).padStart(6,'0');
  const color2 = '#' + ((hash * 23333 + 12345) % 16777215).toString(16).padStart(6,'0');
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${size}' height='${size}'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='${color1}'/><stop offset='1' stop-color='${color2}'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><text x='50%' y='54%' dominant-baseline='middle' text-anchor='middle' fill='rgba(255,255,255,0.95)' font-weight='800' font-size='40'>${name}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function ensureSkinsAndThemes(){
  game.skins = game.skins || {};
  const ELEMENTS = ['Fire','Ice','Water','Air','Crystal','Shadow','Metal','Light','Mist','Void','Neon','Galaxy','Sun','Lava','Frost','Aurora','Copper','Bronze','Obsidian','Pearl'];
  ELEMENTS.forEach((elName, idx)=>{
    const id = elName.toLowerCase();
    if(!game.skins[id]){
      game.skins[id] = { id, name: elName, dataUri: genSkinSVG(elName), price: 200 + idx*400, rarity: ['common','common','rare','epic','legendary'][Math.floor(Math.random()*5)], owned:false };
    }
  });
  const BASE_SHOP_SKINS = [
    {id:'sprinkles', name:'Sprinkles', price:250, rarity:'common'},
    {id:'choco', name:'Choco Drip', price:800, rarity:'common'},
    {id:'neon', name:'Neon Glow', price:2500, rarity:'rare'},
    {id:'retro', name:'Retro Plaque', price:8000, rarity:'epic'}
  ];
  BASE_SHOP_SKINS.forEach(s=>{ if(!game.skins[s.id]) game.skins[s.id] = { id:s.id, name:s.name, dataUri: genSkinSVG(s.name), price:s.price, rarity:s.rarity || 'common', owned:false }; });
  if(!game.skins['icecream']) game.skins['icecream'] = { id:'icecream', name:'Ice Cream', dataUri: genSkinSVG('Ice Cream'), price:0, rarity:'special', owned:false };
  if(!game.skins['mace']) game.skins['mace'] = { id:'mace', name:'Mace', dataUri: genSkinSVG('Mace'), price:0, rarity:'special', owned:false };
  if(!game.skins['default']) game.skins['default'] = { id:'default', name:'Default', dataUri:null, price:0, rarity:'common', owned:true };
  game.ownedSkins = game.ownedSkins || [];
  Object.values(game.skins).forEach(s=>{ if(s.owned && !game.ownedSkins.includes(s.id)) game.ownedSkins.push(s.id); });
  if(!game.selectedSkin && game.ownedSkins.length>0) game.selectedSkin = game.ownedSkins[0];
}

/* -------------------------
   DOM Refs & state
*/
let game = JSON.parse(JSON.stringify(DEFAULT));
const $ = id => document.getElementById(id);
const cookiesEl = $('cookies'), cpsEl = $('cps'), clicksEl = $('clicks'), bigBtn = $('bigBtn'), bigLabel = $('bigLabel');
const upgradesWrap = $('upgrades'), storeWrap = $('store'), logEl = $('log'), achWrap = $('achievements');
const skinGrid = $('skinGrid'), playerList = $('playerList');
const prestigeBtnEl = $('prestigeBtn'), prestigeCostEl = $('prestigeCost');

/* -------------------------
   BroadcastChannel (presence)
*/
let bc = null;
function initBroadcastChannel(){
  try{
    if(typeof BroadcastChannel !== 'undefined'){
      bc = new BroadcastChannel('random_click_channel_v1');
      bc.onmessage = (ev) => {
        const msg = ev.data;
        if(!msg || !msg.type) return;
        if(msg.from === game.playerName) return;
        switch(msg.type){
          case 'presence':
            game.presence = game.presence || {};
            game.presence[msg.from] = { name: msg.from, selectedSkin: msg.selectedSkin, cookies: msg.cookies, lastSeen: Date.now() };
            renderPlayerList();
            break;
          case 'equipSkin':
            game.presence = game.presence || {};
            game.presence[msg.from] = game.presence[msg.from] || {};
            game.presence[msg.from].selectedSkin = msg.skin;
            renderPlayerList();
            break;
          case 'purchase':
            addLog(`[${msg.from}] bought ${msg.item}`);
            break;
          default: break;
        }
      };
    } else {
      addLog('BroadcastChannel not supported â€” multiplayer presence disabled.');
    }
  }catch(e){ console.warn('BroadcastChannel init failed', e); }
}
function broadcastPresence(){
  if(!bc || !game.playerName) return;
  bc.postMessage({ type:'presence', from: game.playerName, selectedSkin: game.selectedSkin, cookies: game.cookies });
}
function broadcastEquip(skinId){
  if(!bc || !game.playerName) return;
  bc.postMessage({ type:'equipSkin', from: game.playerName, skin: skinId });
}
function broadcastPurchase(itemId){
  if(!bc || !game.playerName) return;
  bc.postMessage({ type:'purchase', from: game.playerName, item: itemId });
}

/* -------------------------
   Logging & toasts
*/
function addLog(msg, cls){
  const t = new Date().toLocaleTimeString();
  const d = document.createElement('div');
  d.textContent = `[${t}] ${msg}`;
  if(cls) d.className = cls;
  logEl.prepend(d);
  while(logEl.children.length > 1000) logEl.removeChild(logEl.lastChild);
}
function announceToast(text){
  const toast = document.createElement('div');
  toast.textContent = text;
  toast.style.position = 'fixed';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.bottom = '22px';
  toast.style.background = 'linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02))';
  toast.style.padding = '10px 14px';
  toast.style.borderRadius = '8px';
  toast.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';
  toast.style.zIndex = 9999;
  document.body.appendChild(toast);
  setTimeout(()=>{ toast.style.opacity = 0; toast.style.transform = 'translateX(-50%) translateY(20px)'; }, 2200);
  setTimeout(()=>toast.remove(), 2800);
}

/* -------------------------
   Core click action (prestige multiplier applied)
*/
function clickBake(){
  const baseClick = 1;
  const prestigeMultiplier = Math.pow(2, game.prestige || 0); // each prestige doubles click power
  const perClick = Math.max(1, Math.floor(baseClick * (game.multiplier || 1) * prestigeMultiplier));
  game.cookies += perClick;
  game.clicks += 1;
  // first click auto-skin unlock
  if(game.clicks === 1){
    if(game.skins['icecream']) {
      game.skins['icecream'].owned = true;
      if(!game.ownedSkins.includes('icecream')) game.ownedSkins.push('icecream');
      game.selectedSkin = 'icecream';
      addLog('Unlocked Ice Cream skin for first click!');
    }
  }
  flashBigButton();
  playTickSound();
  checkAchievements();
  updateUI();
  if(game.playerName) broadcastPresence();
}

/* -------------------------
   Buy item logic
*/
function buyItem(item){
  if(!item) return;
  if(item.type === 'one-time'){
    if(game.upgrades[item.id]) return addLog('Already purchased.');
    if(game.cookies < item.cost) return addLog('Not enough cookies.');
    game.cookies -= item.cost;
    game.upgrades[item.id] = true;
    if(item.effect) try{ item.effect(game); }catch(e){ console.warn('upgrade effect failed', e); }
    addLog(`Purchased: ${item.name}`);
    announceToast(`Purchased ${item.name}`);
  } else if(item.type === 'producer'){
    const currentCost = game.producerCosts[item.id] || item.cost;
    if(game.cookies < currentCost) return addLog('Not enough cookies.');
    game.cookies -= currentCost;
    game.producers[item.id] = (game.producers[item.id]||0) + 1;
    const next = Math.ceil(currentCost * 1.15);
    game.producerCosts[item.id] = next;
    addLog(`Bought ${item.name} (x${game.producers[item.id]}) â€” paid ${fmt(currentCost)}`);
    broadcastPurchase(item.id);
    const totalProducers = Object.values(game.producers).reduce((s,n)=>s+(n||0),0);
    if(totalProducers >= 3 && game.skins['mace'] && !game.skins['mace'].owned){
      game.skins['mace'].owned = true;
      if(!game.ownedSkins.includes('mace')) game.ownedSkins.push('mace');
      addLog('Unlocked Mace skin for buying 3 producers!');
    }
  } else if(item.type === 'theme'){
    if(game.cookies < item.cost) return addLog('Not enough cookies for theme.');
    game.cookies -= item.cost;
    if(!game.ownedSkins.includes('theme_'+item.id)) game.ownedSkins.push('theme_'+item.id);
    addLog(`Purchased theme: ${item.name}`);
    applyTheme(item.id);
    saveGame();
  }
  recalcCps();
  checkAchievements();
  updateUI();
}

/* -------------------------
   Recalc CPS
*/
function recalcCps(){
  let total = 0;
  Object.entries(game.producers).forEach(([id,count])=>{
    const it = ITEMS[id];
    if(it && it.baseCps) total += it.baseCps * count;
  });
  if(game.upgrades['steamOven']) total = Math.floor(total * 1.5);
  if(game.upgrades['solarPanels']) total = Math.floor(total * 3);
  if(game.upgrades['galacticCookware']) total = Math.floor(total * 10);
  if(game.devMode) total = Math.floor(total * 10);
  game.cps = Math.floor(total);
}

/* -------------------------
   Tick (every second)
*/
function tick(){
  if(game.cps > 0){
    game.cookies += game.cps;
    checkAchievements();
    updateUI();
    if(game.playerName) broadcastPresence();
  }
}

/* -------------------------
   Achievements
*/
function checkAchievements(){
  ACH.forEach(a=>{
    try{
      if(!game.achievements[a.id] && a.cond(game)){
        game.achievements[a.id] = true;
        announceAchievement(a);
      }
    }catch(e){
      console.warn('ach cond failed', a.id, e);
    }
  });
  renderAchievements();
}
function announceAchievement(a){
  addLog(`Achievement: ${a.name} â€” ${a.desc}`);
  announceToast(`ðŸ† ${a.name}`);
}

/* -------------------------
   Skin rendering
*/
function renderSkinGrid(){
  skinGrid.innerHTML = '';
  const keys = Object.keys(game.skins).sort();
  keys.forEach(id=>{
    const s = game.skins[id];
    const card = document.createElement('div'); card.className='skin-card';
    const thumb = document.createElement('div'); thumb.style.width='72px'; thumb.style.height='72px'; thumb.style.borderRadius='6px'; thumb.style.overflow='hidden';
    const img = document.createElement('img'); img.src = s.dataUri || placeholderSkinData(s.id); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    thumb.appendChild(img);
    const meta = document.createElement('div'); meta.style.flex='1';
    const t = document.createElement('div'); t.style.fontWeight='700'; t.textContent = s.name;
    const m = document.createElement('div'); m.className='skin-meta'; m.textContent = `${s.rarity || 'common'} â€¢ ${s.price?fmt(s.price)+' cookies':'Free'}`;
    const btn = document.createElement('button'); btn.className='ghost-btn'; btn.textContent = game.ownedSkins.includes(id) ? (game.selectedSkin===id?'Equipped':'Equip') : 'Buy';
    btn.addEventListener('click', ()=> {
      if(game.ownedSkins.includes(id)){
        equipSkin(id);
      } else {
        if(!s.price) { s.owned = true; game.ownedSkins.push(id); equipSkin(id); saveGame(); updateUI(); }
        else if(game.cookies >= s.price){
          if(confirm(`Buy skin ${s.name} for ${fmt(s.price)} cookies?`)){
            game.cookies -= s.price;
            s.owned = true;
            if(!game.ownedSkins.includes(id)) game.ownedSkins.push(id);
            addLog(`Purchased skin: ${s.name}`);
            equipSkin(id);
            saveGame();
            updateUI();
          }
        } else alert('Not enough cookies.');
      }
      renderSkinGrid();
    });
    meta.appendChild(t); meta.appendChild(m);
    card.appendChild(thumb); card.appendChild(meta); card.appendChild(btn);
    skinGrid.appendChild(card);
  });
}
function placeholderSkinData(id){
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='100%' height='100%' fill='#2b2b2b'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#fff' font-size='28'>${id}</text></svg>`;
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
}
function equipSkin(id){
  if(!game.ownedSkins.includes(id)) return;
  game.selectedSkin = id;
  addLog(`Equipped skin: ${game.skins[id].name}`);
  applySelectedSkinToButton();
  saveGame();
  broadcastEquip(id);
}
function removeSkin(id){
  const idx = game.ownedSkins.indexOf(id);
  if(idx>=0) game.ownedSkins.splice(idx,1);
  if(game.skins[id]){
    if(id.startsWith('custom_')) delete game.skins[id];
    else game.skins[id].owned = false;
  }
  if(game.selectedSkin===id) game.selectedSkin = null;
  addLog(`Removed skin: ${id}`);
  saveGame();
  renderSkinGrid();
  updateUI();
}
function applySelectedSkinToButton(){
  const existing = bigBtn.querySelector('img.skin-img');
  if(existing) existing.remove();
  if(game.selectedSkin && game.skins[game.selectedSkin]){
    const data = game.skins[game.selectedSkin].dataUri || placeholderSkinData(game.selectedSkin);
    const img = document.createElement('img'); img.className = 'skin-img'; img.src = data; bigBtn.prepend(img);
    bigLabel.style.display = 'none';
  } else {
    bigLabel.style.display = 'block';
  }
}

/* -------------------------
   Store rendering
*/
function createUpgradeNode(item){
  const tpl = document.getElementById('upgradeTemplate');
  const node = tpl.content.firstElementChild.cloneNode(true);
  node.dataset.id = item.id;
  node.querySelector('.name').textContent = item.name;
  node.querySelector('.desc').textContent = item.desc;
  node.querySelector('.cost').textContent = fmt(item.cost || 0);
  const btn = node.querySelector('.buyBtn');
  btn.addEventListener('click', ()=> buyItem(item));
  return node;
}
function renderStore(){
  upgradesWrap.innerHTML = '';
  storeWrap.innerHTML = '';
  Object.values(ITEMS).forEach(item=>{
    const node = createUpgradeNode(item);
    if(item.type==='producer') storeWrap.appendChild(node);
    else if(item.type==='theme') {
      // themes not shown in upgrades list here
    } else upgradesWrap.appendChild(node);
  });
  updateUI();
}
function updateUI(){
  cookiesEl.textContent = fmt(game.cookies);
  cpsEl.textContent = fmt(game.cps);
  clicksEl.textContent = String(game.clicks);
  $('prestige').textContent = String(game.prestige || 0);

  document.querySelectorAll('.upgrade').forEach(node=>{
    const id = node.dataset.id;
    const item = ITEMS[id];
    if(!item) return;
    let cost = item.cost;
    if(item.type==='producer') cost = game.producerCosts[id] || item.cost;
    node.querySelector('.cost').textContent = fmt(cost);
    const btn = node.querySelector('.buyBtn');
    const affordable = game.cookies >= cost;
    btn.disabled = !affordable;
    btn.style.opacity = affordable?1:0.55;
    if(item.type==='one-time'){
      if(game.upgrades[item.id]){ node.classList.add('locked'); btn.textContent = 'Owned'; btn.disabled=true; btn.style.opacity=0.5; }
      else { node.classList.remove('locked'); btn.textContent='Buy'; }
    } else {
      btn.textContent = 'Buy';
      if(!node.querySelector('.count')){ const c=document.createElement('div'); c.className='count'; c.style.fontSize='12px'; c.style.marginTop='6px'; node.querySelector('.info').appendChild(c); }
      node.querySelector('.count').textContent = `Owned: ${game.producers[item.id]||0}`;
    }
  });

  renderSkinGrid();
  renderPlayerList();
  renderAchievements();
  lastSavedText();
  updatePrestigeUI();
}

/* -------------------------
   Achievements & players
*/
function renderAchievements(){
  achWrap.innerHTML = '';
  ACH.forEach(a=>{
    const d = document.createElement('div'); d.className='ach'; d.textContent = a.name + (game.achievements[a.id] ? ' âœ…' : '');
    achWrap.appendChild(d);
  });
}
function renderPlayerList(){
  playerList.innerHTML = '';
  const local = { name: game.playerName || 'You', selectedSkin: game.selectedSkin, cookies: game.cookies };
  const arr = [];
  if(game.playerName) arr.push(local);
  if(game.presence){
    Object.values(game.presence).forEach(p=>{
      if(p && p.name && p.name !== game.playerName) arr.push(p);
    });
  }
  if(arr.length===0) playerList.innerHTML = '<div class="small">No players present (join to announce yourself)</div>';
  arr.forEach(p=>{
    const row = document.createElement('div'); row.className='player-row';
    const left = document.createElement('div'); left.textContent = p.name;
    const center = document.createElement('div'); center.className='small'; center.textContent = `Cookies: ${fmt(p.cookies||0)}`;
    const right = document.createElement('div');
    if(p.selectedSkin){
      const img = document.createElement('img'); img.src = (game.skins && game.skins[p.selectedSkin] && game.skins[p.selectedSkin].dataUri) ? game.skins[p.selectedSkin].dataUri : placeholderSkinData(p.selectedSkin);
      img.style.width='36px'; img.style.height='36px'; img.style.borderRadius='6px'; img.style.objectFit='cover';
      right.appendChild(img);
    }
    row.appendChild(left); row.appendChild(center); row.appendChild(right);
    playerList.appendChild(row);
  });
}

/* -------------------------
   Save / load / export / import
*/
function saveGame(){
  try{
    game.lastSaved = Date.now();
    localStorage.setItem(SAVE_KEY, JSON.stringify(game));
    addLog('Game saved locally.');
    lastSavedText();
  }catch(e){ console.error(e); addLog('Save failed.'); }
}
function loadGame(){
  try{
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    game = Object.assign({}, DEFAULT, parsed);
    Object.values(ITEMS).forEach(it=>{
      if(it.type==='producer'){
        game.producers[it.id] = game.producers[it.id] || 0;
        game.producerCosts[it.id] = game.producerCosts[it.id] || it.cost;
      }
    });
    game.skins = game.skins || {};
    game.ownedSkins = game.ownedSkins || [];
    game.uploadTier = game.uploadTier || 0;
    if(game.adminHoldEnabled === undefined) game.adminHoldEnabled = false;
    if(!game.prestigeCost) game.prestigeCost = DEFAULT.prestigeCost;
    recalcCps();
    renderStore();
    renderAchievements();
    updateUI();
    applySelectedSkinToButton();
    addLog('Loaded save.');
  }catch(e){ console.error(e); addLog('Load failed.'); }
}

/* End of PART 1 */
